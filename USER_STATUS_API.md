# API для управления статусом пользователей

## Описание

Система позволяет отслеживать онлайн/оффлайн статус пользователей и автоматически отключать уведомления в боте для онлайн пользователей.

## Эндпоинты

### 1. Установить пользователя как онлайн

```
POST /user-status/:telegramId/online
```

**Описание**: Устанавливает пользователя как онлайн на 5 минут.

**Параметры**:

- `telegramId` (string) - ID пользователя в Telegram

**Ответ**:

```json
{
	"success": true,
	"message": "Пользователь установлен как онлайн"
}
```

### 2. Установить пользователя как оффлайн

```
POST /user-status/:telegramId/offline
```

**Описание**: Устанавливает пользователя как оффлайн.

**Параметры**:

- `telegramId` (string) - ID пользователя в Telegram

**Ответ**:

```json
{
	"success": true,
	"message": "Пользователь установлен как оффлайн"
}
```

### 3. Обновить активность пользователя

```
POST /user-status/:telegramId/activity
```

**Описание**: Продлевает онлайн статус пользователя на 5 минут.

**Параметры**:

- `telegramId` (string) - ID пользователя в Telegram

**Ответ**:

```json
{
	"success": true,
	"message": "Активность пользователя обновлена"
}
```

### 4. Проверить статус пользователя

```
GET /user-status/:telegramId/status
```

**Описание**: Проверяет, онлайн ли пользователь.

**Параметры**:

- `telegramId` (string) - ID пользователя в Telegram

**Ответ**:

```json
{
	"success": true,
	"data": {
		"isOnline": true
	},
	"message": "Пользователь онлайн"
}
```

### 5. Получить список онлайн пользователей

```
GET /user-status/online
```

**Описание**: Возвращает список всех онлайн пользователей.

**Ответ**:

```json
{
	"success": true,
	"data": {
		"onlineUsers": ["123456789", "987654321"]
	},
	"message": "Найдено 2 онлайн пользователей"
}
```

## Как это работает

### Автоматическое управление статусом

1. **При входе в приложение**: Вызывайте `POST /user-status/:telegramId/online`
2. **При активности пользователя**: Вызывайте `POST /user-status/:telegramId/activity` (можно делать это периодически)
3. **При выходе из приложения**: Вызывайте `POST /user-status/:telegramId/offline`

### Отключение уведомлений

- Когда пользователь онлайн, уведомления в боте автоматически отключаются
- Уведомления включаются снова, когда пользователь становится оффлайн
- TTL онлайн статуса: 5 минут (автоматически сбрасывается при неактивности)

### Интеграция с клиентом

```javascript
// При входе пользователя
await fetch('/user-status/123456789/online', { method: 'POST' })

// Периодическое обновление активности (каждые 2-3 минуты)
setInterval(async () => {
	await fetch('/user-status/123456789/activity', { method: 'POST' })
}, 120000) // 2 минуты

// При выходе пользователя
await fetch('/user-status/123456789/offline', { method: 'POST' })
```

## Логика работы

1. **Redis ключи**: `user:{telegramId}:status` со значением `online` и TTL 300 секунд
2. **Автоматическое истечение**: Если пользователь не активен 5 минут, статус автоматически сбрасывается
3. **Проверка перед уведомлениями**: Система проверяет онлайн статус перед отправкой уведомлений в бот
4. **События**: При изменении статуса публикуются события в Redis Pub/Sub

## Преимущества

- ✅ Пользователи не получают спам уведомлений, когда активны в приложении
- ✅ Автоматическое управление статусом через TTL
- ✅ Простая интеграция с клиентским приложением
- ✅ Масштабируемость через Redis
- ✅ События для real-time обновлений
